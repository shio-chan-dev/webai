# 游戏币 / Token 设计

本文档描述游戏币（虚拟币 / Token）的设计，包括链下积分模式、链下 + 链上混合模式以及完全链上托管模式，并重点说明 MVP 使用的「完全链下」方案。

---

## 1. 游戏币基础设定

### 1.1 命名与单位（示例）

- 名称（展示给用户）：例如「星尘」、「能量点」、「AI 币」等，可根据产品调性命名
- 内部代号：`GC`（Game Coin）或 `AIC`（AI Coin）
- 精度：
  - 链下：可以直接使用整数，表示最小单位（例如 1 表示 1 个游戏币）
  - 链上：参考 ERC20，通常使用 18 位小数

### 1.2 功能定位

- 消耗型虚拟货币，用于：
  - 支付 AI 调用费用
  - 参与抽奖 / 活动
  - 购买虚拟道具或会员权益
- 激励型资产，用于：
  - 注册赠币
  - 完成任务奖励
  - 活动奖励与运营补贴

---

## 2. 模式 A：完全链下游戏币（MVP 使用）

特点：

- 所有余额和交易记录都保存在数据库
- 无需区块链、无钱包、无 gas
- 对用户完全透明，体验接近普通 App 的「积分」

数据结构（简化）：

- `users.balance`：用户当前可用游戏币余额
- `transactions`：
  - `id`
  - `user_id`
  - `amount`（正负）
  - `type`（`recharge` / `reward` / `cost` / ...）
  - `created_at`
  - `meta`（JSON 字段，记录业务来源）

业务规则示例：

- 初始赠币
  - 注册成功后给定一个固定值（例如 1000 游戏币）
  - 写一条 `transactions`（`type=reward`，`amount=+1000`）
- AI 调用扣费
  - 按调用计价，例如「每条请求 10 游戏币」
  - 也可以按模型 / 功能设定不同价格
  - 扣费时写一条 `transactions`（`type=cost`，`amount=-10`）
- 任务奖励
  - 完成某任务后发放指定奖励
  - 写一条 `transactions`（`type=reward`）

MVP 只实现模式 A，保证可以快速上线并验证产品形态。

---

## 3. 模式 B：链下 + 链上同步（Hybrid）

适用场景：

- 平台早期以 Web2 用户为主，不希望用户面对钱包与链上复杂度
- 中后期希望引入 Web3 经济：如融资、空投、跨平台流通

基本思路：

- 大部分用户只用链下游戏币（积分）
- 提供「提现到链上」功能：
  - 用户发起提现请求，选择提现数量
  - 后端检查其链下余额并冻结对应金额
  - 后端调用区块链合约，在链上给用户地址转相应 ERC20 代币
  - 链上交易成功后，扣减链下余额并记录同步状态

架构变化：

- 新增链上相关表，例如：
  - `onchain_withdrawals`：提现记录表
  - `onchain_deposits`：链上充值（如从外部钱包转入）记录
- 平台后端需集成 Web3 库（如 `web3.py`），监听合约事件或轮询链上状态

MVP 阶段不必实现，只需在架构与数据库设计中为其预留空间。

---

## 4. 模式 C：完全链上但对用户隐藏（托管 / AA）

适用场景：

- 希望在保持 Web2 体验的同时，完全享受区块链透明性与资产属性

实现思路：

- 后端为每个用户创建托管钱包或智能账户（AA）
- 所有游戏币都以链上 ERC20 代币形式存在
- 用户在前端只看到「余额数值」，后端在链上完成实际转账

技术方式示例：

- 普通托管钱包：
  - 使用 `eth_account.Account.create()` 为用户生成私钥
  - 由平台安全存储并代为签名交易
- AA（Account Abstraction）方案：
  - 使用 Alchemy AA SDK / Privy / Biconomy 等服务
  - 支持邮箱 / 手机登录 + 无 gas 体验（由平台代付手续费）

安全与合规风险更高，需要更严格的私钥管理、风控和审计。

---

## 5. 计费策略设计

计费维度可以灵活配置：

- 按调用计费
  - 每次请求固定扣除 X 游戏币
  - 适用于简单聊天或固定复杂度的调用
- 按 usage（Token 数 / 字数 / 时长）计费
  - AI 服务返回 `usage` 信息
  - 平台按「单价」计算实际扣费金额
- 按模型 / 功能类别计费
  - 不同模型（例如基础模型、高级模型）或功能（图像生成）有不同单价

建议在数据库中维护「价格配置」表，方便后续调整价格而不改代码。

---

## 6. 反作弊与风控

为了防止滥用与薅羊毛，需要在游戏币逻辑上增加基本风控：

- 注册赠币限制
  - 每个手机号 / 邮箱 / 设备 / IP 在一定时间窗口内只享受一次赠币
- 可疑行为监控
  - 同一 IP 大量注册
  - 异常高频 AI 调用
  - 短时间内大量获得奖励
- 管理员工具
  - 封禁账户 / 冻结余额
  - 手动调整余额并记录原因

详细风控策略与技术方案见 `docs/SECURITY_RISK_CONTROL.md`。

---

## 7. MVP 实施要点

MVP 阶段主要关注：

- 实现稳定的链下余额与交易系统
- 在 AI 调用入口实现扣费逻辑
- 在前端清晰地呈现余额与交易记录

不必在一开始就实现：

- 链上代币合约与托管钱包
- 复杂的金融逻辑（利息、质押等）

等产品验证与用户规模达到一定程度再逐步演进。

