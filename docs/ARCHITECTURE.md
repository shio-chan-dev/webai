# 系统架构说明

本文档描述 AI DApp + 游戏币系统平台的整体架构、组件划分与关键数据流，重点围绕「链下游戏币 + 可扩展 Web3 能力」的设计。

---

## 1. 总体架构视图

逻辑分层如下：

```text
┌────────────────────────────┐
│        前端 Web / App      │
│  - 登录 / 注册             │
│  - AI 对话                 │
│  - 游戏币钱包              │
│  - 任务 / 商城             │
└─────────────▲──────────────┘
              │ HTTP / WebSocket
┌─────────────┴──────────────┐
│     平台后端（本项目）      │
│  - 用户与认证               │
│  - 链下游戏币余额与流水     │
│  - AI 调用计费与转发        │
│  - 任务 / 奖励 / 商城       │
│  - 后台管理接口             │
└─────────────▲──────────────┘
              │ HTTP / gRPC
┌─────────────┴──────────────┐
│   AI 模型服务（独立项目）   │
│  - 文本 / 图像 / 多模态     │
│  - 推理与计费指标统计       │
└─────────────▲──────────────┘
              │（可选）链上交互
┌─────────────┴──────────────┐
│     Web3 层（可选、非 MVP） │
│  - ERC20 代币合约           │
│  - 支付合约                 │
│  - 托管钱包 / AA 账户       │
└────────────────────────────┘
```

MVP 阶段只实现「前端 Web + 平台后端 + 链下游戏币」，Web3 层保留为扩展选项。

---

## 2. 平台后端职责

平台后端（本项目）的核心职责：

- 用户体系
  - 账号注册 / 登录（邮箱 / 手机号）
  - 基于 Token 的认证
  - 用户基础信息维护
- 链下游戏币系统
  - 每个用户的余额记录
  - 交易流水（充值 / 奖励 / 扣费）
  - 初始赠币逻辑
  - 任务奖励、活动奖励等发币逻辑
- AI 调用计费与转发
  - 接收前端发来的 AI 请求
  - 根据计费策略计算所需游戏币额度
  - 检查余额、扣费、记录交易
  - 调用独立 AI 服务接口并转发响应
- 任务 / 商城系统（MVP 可先做简单版本）
  - 定义任务（例如「首次登录」、「分享给好友」）
  - 领取任务奖励
  - 游戏内道具 / 增值功能兑换
- 后台管理
  - 管理员登录
  - 人工发币 / 调整余额
  - 查看用户与交易列表

所有外部请求统一由平台后端处理，前端和 AI 服务都不直接接触链上或钱包逻辑（即使后续引入 Web3，也由平台后端统一接入）。

---

## 3. AI 服务（独立项目）对接方式

AI 服务不在本仓库内实现，只需定义好接口与契约。

建议：

- AI 服务暴露统一 HTTP 接口，例如：
  - `POST /ai/chat`：对话
  - `POST /ai/generate`：文生文 / 文生图
- 响应体包含：
  - `data`：模型输出内容
  - `usage`：本次调用的 Token 数、时长等指标（可用于计费）
- （可选）AI 服务内部记录调用明细，用于监控与调优

平台后端通过配置（环境变量或配置文件）保存 AI 服务的 URL 和鉴权信息。

---

## 4. 游戏币模式与架构扩展

游戏币支持三种模式：

1. 完全链下模式（MVP 使用）
   - 所有余额与交易仅保存在数据库
   - 无钱包、无 gas、最快上线
2. 链下 + 链上同步模式
   - 用户在平台内使用链下游戏币
   - 高级用户可以申请「提现」为链上 ERC20 代币
   - 后端负责链上铸币 / 转账，并维护同步状态
3. 完全链上但对用户隐藏（托管 / AA）
   - 后端代用户创建钱包和签名交易
   - 用户只看到「游戏币」，实际为链上代币

架构上的约束是：

- 平台后端对「余额」和「交易」提供统一接口
- Web3 层被封装在后端内部的适配层中，不直接暴露给前端

---

## 5. 模块划分（后端）

可以按「领域服务」进行模块划分：

- `auth` 模块
  - 用户注册 / 登录 / Token 刷新
- `user` 模块
  - 用户资料查询与更新
- `wallet` 模块（链下游戏币）
  - 余额查询与更新
  - 交易流水管理
- `ai` 模块
  - AI 请求统一入口
  - 计费策略（按调用 / Token / 模型类型）
  - 请求 AI 服务
- `task` 模块
  - 任务定义与配置
  - 用户任务进度与奖励发放
- `admin` 模块
  - 管理员登录
  - 后台发币、风控操作

模块职责与 API 设计详见 `docs/API_DESIGN.md`。

---

## 6. 前端架构

推荐使用 SPA / SSR 框架（如 React / Next.js），基本路由：

- `/login`：登录 / 注册
- `/app/chat`：AI 对话页面
- `/wallet`：游戏币钱包页面
- `/tasks`：任务与奖励页面
- `/admin`：后台入口（可单独子应用）

前端通过 REST API（或部分 WebSocket）与平台后端交互，所有与游戏币和 AI 调用相关的逻辑都交给后端处理。

详细交互与页面布局见 `docs/FRONTEND_SPEC.md`。

---

## 7. 数据流示例：一次 AI 调用

1. 用户在前端输入问题，点击发送
2. 前端调用平台后端 `POST /api/ai/chat`
3. 平台后端：
   - 校验用户身份与请求参数
   - 根据计费策略计算本次调用价格
   - 检查用户余额是否足够
   - 扣减余额，记录一条扣费交易
   - 将请求转发给 AI 服务，并等待响应
   - 将 AI 响应和本次计费信息返回前端
4. 前端展示 AI 回复，并可在钱包页面看到余额变化与流水记录

---

## 8. 部署与环境

建议部署拓扑：

- 前端：静态资源托管 / Vercel / Nginx
- 平台后端：容器化部署（Docker + 任意云或自托管）
- 数据库：PostgreSQL / MySQL（MVP 推荐单实例 + 定期备份）
- AI 服务：独立容器或 GPU 节点

不同环境（开发 / 测试 / 生产）通过配置隔离：

- AI 服务地址
- 数据库连接串
- 游戏币计价策略
- 日志与监控配置

详细环境规划可以根据实际部署平台补充在 `docs/SECURITY_RISK_CONTROL.md` 或单独的部署文档中。

